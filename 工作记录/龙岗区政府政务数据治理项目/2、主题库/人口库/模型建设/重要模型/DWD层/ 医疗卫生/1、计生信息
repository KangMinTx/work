 --SparkSQL
--_********************************************************_
--author: lgadmin
--create time: 2020-11-20 16:07:28
--table_name : dwd_shhd_jsxx(è®¡ç”Ÿä¿¡æ¯)
--use_tables : std_swsjkwyh_pop_children(æ·±åœ³å¸‚å«ç”Ÿå¥åº·å§”å‘˜ä¼š_ç”Ÿè‚²ä¿¡æ¯)
-- 			   ods_swsjkwyh_pop_person(æ·±åœ³å¸‚å«ç”Ÿå¥åº·å§”å‘˜ä¼š_äººå£åŸºæœ¬ä¿¡æ¯)
--             std_zfw_resident1(æ”¿æ³•å§”åŸºç¡€ä¿¡æ¯)
--å–æ•°é€»è¾‘ :   1ã€POP_PERSONä¸­ä»¥è¯ä»¶å·ç å…³è”é¾™å²—åŒºæ”¿æ³•å§”â€œZFW_RESIDENT1â€œè¡¨ï¼Œè·å–é¾™å²—åŒºäººå£èŒƒå›´æ¸…å•ï¼ˆäººå‘˜æ ‡è¯†IDã€è¯ä»¶å·ç ã€è¯ä»¶ç±»å‹ã€å§“åã€æ€§åˆ«ï¼‰ï¼Œä½œä¸ºä¸´æ—¶è¡¨ã€‚
--			  2ã€POP_CHILDRENè¡¨ä¸­æ ¹æ®çˆ¶äº²IDå’Œæ¯äº²IDæ‹†æˆä¸¤å¼ è¡¨ï¼Œå†é€šè¿‡IDå…³è” ä¸´æ—¶è¡¨ è·å–è¯ä»¶å·ç ã€è¯ä»¶ç±»å‹ç­‰å…¶ä»–å­—æ®µ
--å»é‡é€»è¾‘: æ ¹æ®èº«ä»½è¯å·,é€šè¿‡ timeflag å€’åº å–æœ€æ–°æ•°æ®
--æ’å…¥è¯­å¥åœ¨ä¸‹æ–¹:ğŸ‘‡
--_********************************************************_

--ä¿®æ”¹å…ˆå…³è”å†ç­›é€‰ä¸ºå…ˆå…ˆç­›é€‰åå…³è” æœ€åçš„ WHERE t1.rn=1 æ”¹ä¸º åœ¨t1å†…where
--æ™´é£ 2021-03-19

with table_temp AS (
SELECT  *
FROM 
(
	SELECT  t1.guid 
	       ,t1.identity_number                                                     AS zjhm 
	       ,t1.identity_type                                                       AS zjlx 
	       ,t1.person_name                                                         AS xm 
	       ,t1.gender                                                              AS xb 
	       ,row_number() over(partition by identity_number ORDER BY t1.timeflag desc) AS rn
	FROM ods_swsjkwyh_pop_person t1
	INNER JOIN 
	(
		SELECT  *
		FROM ods_qzfw_zfw_resident1
		WHERE dt=( 
		SELECT  MAX(dt)
		FROM ods_qzfw_zfw_resident1) 
	) t2
	ON t1.identity_number=t2.cardno 
  where t1.dt=(select max(dt) from ods_swsjkwyh_pop_person)
)
WHERE rn=1 )  
 insert overwrite table dwd_shhd_jsxx partition (dt='${DayBeforeStartTime}')

SELECT  
	    "ä¸­åäººæ°‘å…±å’Œå›½å±…æ°‘èº«ä»½è¯" as zjlb
	   ,t2.zjhm 
       ,t2.xm 
       ,t2.xb 
       ,t1.syzc 
       ,t1.swyy 
       ,t1.znswrq 
       ,t1.jszjhm 
       ,t1.jszjffrq 
       ,t1.syzfzdbm 
       ,substr(t1.dszngrzlqr,1,10) 
       ,'std_swsjkwyh_pop_children' AS lyb 
       ,t1.lyjg 
       ,current_timestamp           AS yxrq
FROM 
(
  select * from (
    	SELECT  b1.current_mother_guid                                                        AS guid 
	       ,b1.fertility_policy                                                           AS syzc --ç”Ÿè‚²æ”¿ç­– 
	       ,b1.children_death_reason                                                      AS swyy --å­å¥³æ­»äº¡åŸå› ç¼–ç  
	       ,b1.children_death_date                                                        AS znswrq --å­å¥³æ­»äº¡æ—¥æœŸ 
	       ,b1.adopt_number                                                               AS jszjhm --æ”¶å…»è¯ä»¶å·ç  
	       ,b1.adopt_date                                                                 AS jszjffrq --æ”¶å…»è¯ä»¶å‘æ”¾æ—¥æœŸ 
	       ,b1.fertility_certification_number                                             AS syzfzdbm --ç”Ÿè‚²è¯å‘è¯åœ°ç¼–ç  
	       ,b1.glorious_permit_issue_date                                                     AS dszngrzlqr --ç‹¬ç”Ÿå­å¥³çˆ¶æ¯å…‰è£è¯é¢†è¯æ—¥æœŸ 
	       ,row_number() over(partition by b1.current_mother_guid ORDER BY b1.timeflag desc) AS rn 
	       ,b1.lyjg
	FROM std_swsjkwyh_pop_children b1
  	where b1.dt=(select max(dt) from std_swsjkwyh_pop_children)
	UNION ALL
	SELECT  b2.current_father_guid                                                        AS guid 
	       ,b2.fertility_policy                                                           AS syzc --ç”Ÿè‚²æ”¿ç­– 
	       ,b2.children_death_reason                                                      AS swyy --å­å¥³æ­»äº¡åŸå› ç¼–ç  
	       ,b2.children_death_date                                                        AS znswrq --å­å¥³æ­»äº¡æ—¥æœŸ 
	       ,b2.adopt_number                                                               AS jszjhm --æ”¶å…»è¯ä»¶å·ç  
	       ,b2.adopt_date                                                                 AS jszjffrq --æ”¶å…»è¯ä»¶å‘æ”¾æ—¥æœŸ 
	       ,b2.fertility_certification_number                                             AS syzfzdbm --ç”Ÿè‚²è¯å‘è¯åœ°ç¼–ç  
	       ,b2.glorious_permit_issue_date                                                     AS dszngrzlqr --ç‹¬ç”Ÿå­å¥³çˆ¶æ¯å…‰è£è¯é¢†è¯æ—¥æœŸ 
	       ,row_number() over(partition by b2.current_father_guid ORDER BY b2.timeflag desc) AS rn 
	       ,b2.lyjg
	FROM std_swsjkwyh_pop_children b2
    where b2.dt=(select max(dt) from std_swsjkwyh_pop_children)
  ) where rn=1 --ä¸‹é¢çš„whereæ”¹æ”¾åˆ°è¿™é‡Œ

) t1
LEFT JOIN table_temp t2
ON t1.guid = t2.guid
--WHERE t1.rn=1  
